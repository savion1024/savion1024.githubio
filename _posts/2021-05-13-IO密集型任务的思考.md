---
layout:     post
title:      IO密集型任务的思考
subtitle:   关于python的性能
date:       2021-05-13
author:     savion
header-img: img/post-bg-cook.jpg
catalog: true
tags:
- Python
- linux
- 思考
---


## 如何提高python的效率
      
假设现在我们处理大批量数据，
并且这些数据之间不是强制的线性关系，而是并行处理的处理。我们就可以充分思考如何提高效率了。
假设你开单进程单线程处理，那么就是一个队列的情况，前一个任务处理完才到后面一个任务。
但如果我开`多进程`呢，这样就会有多个进程在并行处理，效率有了进一步的提升。
但是除了多进程我们还可以根据任务的类型来决定是否进一步处理，比如任务是`IO密集型`的任务的话，比如网络IO，磁盘IO，这时候可以考虑上多线程，
一般使用`线程池`即可，多个线程不断切换，节省了IO时间，使得cpu的利用率提高。
更进一步，假设IO操作本身就支持`异步`，比如在使用httpx网络库的时候，这时候可以上`协程`（推荐），
因为协程比线程更加轻量，切换成本更低，而且可以可以有很多个协程。

## 配置参数

 一般来说如果要将你的CPU打满以获得最高效率的话，进程数通常要大于等于你服务器的`核心数`。但假设服务器上有其他耗cpu的应用或者系统本身sys占用。进程数可以设小一点。
而在使用线程池和协程的时候更多可以考虑一下`带宽`。服务器受带宽所限单位时间内能通过的流量是有限的，此时你开再多线程或者协程业没有用。瓶颈在带宽上。
而有时也会受到`数据库连接数`的限制，这些都需要分析考虑。
，
## 另外的思考

还有什么可以提高效率？其实就算我们开启多进程的话，进程也不一定会一直就在一个核上运行，这涉及到一个叫做`CPU亲和性`的概念，
当发生进程迁移的时候，cpu缓存就会失效。所以如果我们可以绑定某个进程就一直在某个核上运行，这也会提高效率。
例如NGINX可以通过配置`worker_cpu_affinity` 来将worker进程绑定到固定的核心上从而避免上述情况。

## 参考
-  <http://nginx.org/en/docs/ngx_core_module.html#worker_cpu_affinity>
